language: node_js

services:
  - docker

node_js:
  - "14"

stages:
  - tests
  - start
  - name: deploy
    if: (branch = main) AND (type != pull_request)

jobs:
  include:
    - stage: tests
      name: "prettier check"
      script: npx prettier --check "./**/*.js"

    - stage: start
      name: "build and run images"
      before_install:
        - docker --version
        - docker-compose --version
      install:
        - docker-compose build
      script:
        - docker-compose up -d
        - docker-compose ps
      after_script:
        - docker-compose stop
        - docker-compose ps

    - stage: deploy
      name: "push images to dockerhub"
      install:
        - docker-compose build
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker-compose push
